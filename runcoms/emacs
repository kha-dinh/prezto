;;; packge --- Summary
3;;; Commentary:
;;; Code:
;; Bug fix for newer Emacs
;; (defmacro define-obsolete-function-alias ( obsolete-name current-name
;;                                            &optional when docstring)
;;   "Set OBSOLETE-NAME's function definition to CURRENT-NAME and mark it obsolete.
;; \(define-obsolete-function-alias \\='old-fun \\='new-fun \"22.1\" \"old-fun's doc.\")
;; is equivalent to the following two lines of code:
;; \(defalias \\='old-fun \\='new-fun \"old-fun's doc.\")
;; \(make-obsolete \\='old-fun \\='new-fun \"22.1\")
;; WHEN should be a string indicating when the function was first
;; made obsolete, for example a date or a release number.
;; See the docstrings of `defalias' and `make-obsolete' for more details."
;;   (declare (doc-string 4)
;;            (advertised-calling-convention
;;             ;; New code should always provide the `when' argument
;;             (obsolete-name current-name when &optional docstring) "23.1"))
;;   `(progn
;;      (defalias ,obsolete-name ,current-name ,docstring)
;;      (make-obsolete ,obsolete-name ,current-name ,when)))

;; ;; Straight:
(defvar straight-use-package-by-default)
(setq straight-use-package-by-default t)
(defvar straight-always-use-package-ensure)
(setq  straight-always-use-package-ensure t)
(setq comp-deferred-compilation-deny-list '("\\(?:[^z-a]*-autoloads\\.el$\\)"))

(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  ;; catch emacs updates that have native compiled leftovers
  (unless (catch 'emacs-version-changed
            (load bootstrap-file nil 'nomessage))
    (when (boundp 'comp-eln-load-path)
      ;; remove leftovers, with confirmation just to be safe
      (when (yes-or-no-p (format "Delete '%s'?" (car comp-eln-load-path)))
        (delete-directory (expand-file-name (car comp-eln-load-path)) t))
      ;; and try again
      (load bootstrap-file nil 'nomessage))))

(straight-use-package 'use-package)

(use-package hydra)
(setq remote-file-name-inhibit-cache nil)
(setq vc-ignore-dir-regexp
      (format "%s\\|%s"
              vc-ignore-dir-regexp
              tramp-file-name-regexp))
(use-package tramp
  :init
  (setq tramp-verbose 1)
  )
;; A more complex, more lazy-loaded config
;; Magit
(use-package magit)
(use-package treemacs
  ;; Directory tree
  ;; (use-package treemacs
  ;;   ;; :bind
  ;;   ;; (:map global-map
  ;;   ;;       ("M-0"       . treemacs-select-window)
  ;;   ;;       ("C-x t 1"   . treemacs-delete-other-windows)
  ;;   ;;       ("C-x t t"   . treemacs)
  ;;   ;;       ("C-x t B"   . treemacs-bookmark)
  ;;   ;;       ("C-x t f" . treemacs-find-file)
  ;;   ;;       ("C-x t ." . treemacs-find-tag)
  ;;   ;;       ("C-x t p"   . treemacs-projectile)
  ;;   ;;       )
  :bind
  ("<f8>" . treemacs)
  :config
  ;;   (global-set-key [f8] 'neotree-toggle)
  (treemacs-resize-icons 22)
  (treemacs-follow-mode t)
  (treemacs-filewatch-mode t)           ;
  (treemacs-fringe-indicator-mode 'always)
  ;;   (pcase (cons (not (null (executable-find "git")))
  ;;                (not (null treemacs-python-executable)))
  ;;     (`(t . t)
  ;;      (treemacs-git-mode 'deferred))
  ;;     (`(t . _)
  ;;      (treemacs-git-mode 'simple))))
  )

(use-package treemacs-projectile)
(use-package treemacs-icons-dired
  :config (treemacs-icons-dired-mode))

(defun display-ansi-colors ()
  "Display colors."
  (interactive)
  (let ((inhibit-read-only t))
    (ansi-color-apply-on-region (point-min) (point-max))))
;; Format colors
(add-to-list 'auto-mode-alist '("\\.log\\'" . (display-ansi-colors auto-revert-tail-mode)))
(add-to-list 'auto-mode-alist '("\\.terminal\\'" . (display-ansi-colors auto-revert-tail-mode)))

;; Auto follow
;; (add-to-list 'auto-mode-alist '("\\.log\\'" . ))

(use-package treemacs-magit)

;; (use-package smart-hungry-delete
;;   :bind (("<backspace>" . smart-hungry-delete-backward-char)
;;       ("<C-d>" . smart-hungry-delete-forward-char))
;;   :config (smart-hungry-delete-add-default-hooks)
;;   )
;; Auto resize windows
(use-package zoom
  :config
  (zoom-mode)
  (setq zoom-size '(0.618 . 0.8))
  )
;; Dashboard
(use-package dashboard
  :config ( dashboard-setup-startup-hook))
;; Dim other panels when not used
(use-package which-key
  :hook
  (after-init . which-key-mode)
  :init
  (setq which-key-idle-delay 0.5)
  )
(use-package dimmer
  :hook
  (after-init . dimmer-mode)
  :config
  (dimmer-configure-which-key)
  (dimmer-configure-company-box)
  (dimmer-configure-magit)
  (dimmer-configure-posframe)
  (dimmer-configure-hydra)
  (dimmer-configure-org)

  (setq dimmer-fraction 0.4)
  (setq dimmer-adjustment-mode :foreground)
  (setq dimmer-use-colorspace :ceilab)
  )

(use-package lsp-ui
  :custom
  (lsp-ui-sideline-show-hover t)
  ;; (lsp-ui-doc-enalbe )
  (lsp-ui-doc-position 'at-point)
  (lsp-ui-doc-delay 1.5)
  (lsp-ui-doc-use-childframe nil)
  ;; (lsp-ui-doc-show-with-cursor nil)
  ;; (lsp-ui-doc-show-with-nil nil)
  )
(tooltip-mode -1)
;; ()
;; Centaur tabs
(use-package nyan-mode
  :init
  (setq nyan-wavy-trail t)
  (setq nyan-animation-frame-interval 0.1)
  :config
  (nyan-mode)
  (nyan-start-animation)
  )
;; (setq zone-timer (run-with-idle-timer  t 'zone))
(use-package solaire-mode
  :defines (solaire-mode-auto-swap-bg)
  ;; Ensure solaire-mode is running in all solaire-mode buffers
  :hook (change-major-mode . turn-on-solaire-mode)
  ;; ...if you use auto-revert-mode, this prevents solaire-mode from turning
  ;; itself off every time Emacs reverts the file
  :hook (after-revert . turn-on-solaire-mode)
  ;; To enable solaire-mode unconditionally for certain modes:
  :hook (ediff-prepare-buffer . solaire-mode)
  ;; Highlight the minibuffer when it is activated:
  :hook (minibuffer-setup . solaire-mode-in-minibuffer)
  :config

  ;;   ;; The bright and dark background colors are automatically swapped the first
  ;;   ;; time solaire-mode is activated. Namely, the backgrounds of the `default` and
  ;;   ;; `solaire-default-face` faces are swapped. This is done because the colors
  ;;   ;; are usually the wrong way around. If you don't want this, you can disable it:
  (setq solaire-mode-auto-swap-bg t)
  (solaire-global-mode +1)
  )
;; (use-package cc-mode)
(use-package iedit
  :bind (("C-;" . iedit-mode))
  :init
  (setq iedit-toggle-key-default nil))

(use-package highlight-symbol
  :custom
  (highlight-symbol-idle-delay 0)
  :bind
  ("C-q" . highlight-symbol-next)
  ("M-q" . highlight-symbol-prev)
  :hook
  (prog-mode . highlight-symbol-mode)
  )
(use-package beacon
  :config (beacon-mode 1))
(use-package rainbow-delimiters
  :hook
  (prog-mode . rainbow-delimiters-mode))
(use-package yascroll
  :config (global-yascroll-bar-mode))
(use-package all-the-icons)
(use-package doom-themes
  :custom-face
  (default ((t (:background "#2a2e38"))))
  (hl-line ((t (:background "#383f58"))))
  :custom
  (doom-vibrant-brighter-comments t)
  (doom-vibrant-brighter-modeline t)

  :config
  ;; (setq doom-vibrant-brighter-comments t)
  (load-theme 'doom-vibrant t)
  (global-hl-line-mode)
  (doom-themes-org-config)
  (doom-themes-treemacs-config)
  )
(use-package centaur-tabs
  :demand
  :custom-face
  (centaur-tabs-unselected ((t (:background "#242730"))))
  (centaur-tabs-selected ((t (:background "#2a2e38"))))
  :custom
  (centaur-tabs-set-modified-marker t)
  (centaur-tabs-style "box")
  (centaur-tabs-set-icons t)
  (centaur-tabs-height 36)
  :config
  (defhydra centaur-tab ()
    "Centaur tab move:"
    ("<left>" centaur-tabs-backward)
    ("<right>" centaur-tabs-forward)
    )
  (global-set-key (kbd "C-x t") 'centaur-tab/body)
  ;; (global-set-key (kbd "C-x <left>")  'centaur-tabs-backward)
  ;; (global-set-key (kbd "C-x <right>") 'centaur-tabs-forward)
  (centaur-tabs-headline-match)
  (centaur-tabs-group-by-projectile-project)
  (centaur-tabs-mode)
  :bind
  ("<mouse-8>" . centaur-tabs-backward)
  ("<mouse-9>" . centaur-tabs-forward)
  )
(use-package doom-modeline
  :config
  (doom-modeline-mode)
  )
(use-package rainbow-mode)
;; (use-package material-theme
;;   :straight (material-theme :type git :host github :repo "cpaulik/emacs-material-theme"
;;                             :fork (:host github
;;                                          :repo "kha-dinh/emacs-material-theme"))
;;   :hook
;;   (after-init . (lambda () (load-theme 'material t)))
;;   )

;;;;;;;;;;;;;;;;;;;;;;;;;;
;; NAVIGATION
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Code navigation
;;;;;;;;;;;;;;;;;;;;;;;;;;
(use-package org)
(use-package org-roam-server)
(use-package org-roam
  :ensure t
  :hook
  (org-mode . org-roam-mode)
  :custom
  (org-roam-directory "~/org-roam/")
  (org-roam-db-update-method 'immediate)
  :bind (:map org-roam-mode-map
              (("C-c n l" . org-roam)
               ("C-c n f" . org-roam-find-file)
               ("C-c n g" . org-roam-graph))
              :map org-mode-map
              (("C-c n i" . org-roam-insert))
              (("C-c n I" . org-roam-insert-immediate))))
(use-package org-journal
  :bind
  ("C-c n j" . org-journal-new-entry)
  :custom
  (org-journal-date-prefix "#+title: ")
  (org-journal-file-format "%Y-%m-%d.org")
  (org-journal-dir "~/org-roam/")
  (org-journal-date-format "%A, %d %B %Y"))

(use-package deft
  :after org
  :bind
  ("C-c n d" . deft)
  :custom
  (deft-recursive t)
  (deft-use-filter-string-for-filename t)
  (deft-default-extension "org")
  (deft-directory "~/org-roam/"))


(use-package mwim
  :bind
  ("C-a" . mwim-beginning)
  ("C-e" . mwim-end)
  )

;;;;;;;;;;;;;;;;;;;;;;;;;;
;; PROGRAMMING
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;
(use-package jedi
  :custom
  (jedi:complete-on-dot t)
  (jedi:get-in-function-call-delay 5000)
  (jedi:tooltip-medthod nil)
  :hook
  (python-mode . jedi:setup)
  :config
  (jedi:install-server))

(use-package elpy
  :config
  (elpy-enable)
  (setq elpy-rpc-backend "jedi")
  )
;; Auto follow symlink without asking
(setq vc-follow-symlinks t)
(setq c-default-style "linux")
(setq c-basic-offset 2)

;;    Auto close brackets
(electric-pair-mode)

;; linker scrip mode
(use-package ld-mode
  :straight (ld-mode :type git :host github :repo "spenczar/ld-mode")
  :config
  (ld-mode)
  )
(use-package flycheck
  :init
  (global-flycheck-mode)
  (defun include-paths ()
    ;; Add include dir to path
    (setq flycheck-clang-include-path (list (expand-file-name "../include"))))
  :hook ((c++-mode . include-paths)
         (c-mode . include-paths)
         (c++-mode . (lambda () (setq flycheck-clang-language-standard "c++11")))
         )
  )
(use-package flycheck-color-mode-line
  :init
  (add-hook 'flycheck-mode-hook 'flycheck-color-mode-line-mode))
(use-package flycheck-pos-tip
  :custom
  (flycheck-pos-tip-timeout nil)
  :init
  (flycheck-pos-tip-mode))
(use-package flycheck-irony
  :hook
  (flycheck-mode-hook . flycheck-irony-setup))
(use-package flycheck-checkbashisms
  :init
  :hook
  (flycheck-mode . flycheck-checkbashisms-setup)
  )
(menu-bar-mode -1)
(tool-bar-mode -1)

(setq gc-cons-threshold 100000000)
(setq inhibit-startup-message t)

(defalias 'yes-or-no-p 'y-or-n-p)

;; show unncessary whitespace that can mess up your diff
(add-hook 'prog-mode-hook
          (lambda () (interactive)
            (setq show-trailing-whitespace 1)))

;; use space to indent by default
(setq-default indent-tabs-mode nil)

;; set appearance of a tab that is represented by 4 spaces
(setq-default tab-width 4)

;; Compilation
(global-set-key (kbd "<f5>") (lambda ()
                               (interactive)
                               (setq-local compilation-read-command nil)
                               (call-interactively 'compile)))

;; setup GDB
(setq
 ;; use gdb-many-windows by default
 gdb-many-windows t
 ;; Non-nil means display source file containing the main routine at startup
 gdb-show-main t
 )


;; Package zygospore
(use-package zygospore
  :bind (("C-x 1" . zygospore-toggle-delete-other-windows)
         ("RET" .   newline-and-indent)))

;; automatically indent when press RET
;; activate whitespace-mode to view all whitespace characters
(global-set-key (kbd "C-c w") 'whitespace-mode)
(windmove-default-keybindings)

(setq global-mark-ring-max 5000         ; increase mark ring to contains 5000 entries
      mark-ring-max 5000                ; increase kill ring to contains 5000 entries
      mode-require-final-newline t      ; add a newline to end of file
      tab-width 4                       ; default to 4 visible spaces to display a tab
      make-backup-files nil
      create-lockfiles nil
      auto-save-default nil
      )

;; GROUP: Editing -> Killing
(setq kill-ring-max 5000 ; increase kill-ring capacity
      kill-whole-line t  ; if NIL, kill whole line and move the next line up
      )
(add-hook 'sh-mode-hook (lambda ()
                          (setq tab-width 4)))

(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-language-environment "UTF-8")
(prefer-coding-system 'utf-8)


;; Fix indent in orgmode


(setq-default indent-tabs-mode nil)
(delete-selection-mode)
(global-set-key (kbd "RET") 'newline-and-indent)



;; show whitespace in diff-mode
(add-hook 'diff-mode-hook (lambda ()
                            (setq-local whitespace-style
                                        '(face
                                          tabs
                                          tab-mark
                                          spaces
                                          space-mark
                                          trailing
                                          indentation::space
                                          indentation::tab
                                          newline
                                          newline-mark))
                            (whitespace-mode 1)))

;; Package: volatile-highlights
;; GROUP: Editing -> Volatile Highlights
(use-package volatile-highlights
  :init
  (volatile-highlights-mode t))

;; Package: undo-tree
;; GROUP: Editing -> Undo -> Undo Tree
(use-package undo-tree
  :bind
  (("C-/" . 'undo-tree-undo))
  (("C-x C-/" . 'undo-tree-redo))
  :init
  (global-undo-tree-mode 1))

;; Package: yasnippet
;; GROUP: Editing -> Yasnippet
;; Package: yasnippet
(use-package yasnippet-snippets
  :after yasnippet)
(use-package yasnippet
  :after lsp-mode
  :config (yas-global-mode))
(use-package clean-aindent-mode
  :hook
  (prog-mode . clean-aindent-mode))

;; Package: dtrt-indent
(use-package dtrt-indent
  :init
  (dtrt-indent-mode 1)
  (setq dtrt-indent-verbosity 0))

;; Package: ws-butler
(use-package ws-butler
  :hook
  (
   (prog-mode . ws-butler-mode)
   (text-mode . ws-butler-mode)
   (fundamental-mode . ws-butler-mode)))

;; PACKAGE: comment-dwim-2
(use-package comment-dwim-2
  :bind (("M-;" . comment-dwim-2))
  )

;; PACKAGE: anzu
;; GROUP: Editing -> Matching -> Isearch -> Anzu
(use-package anzu
  :init
  (global-anzu-mode)
  (global-set-key (kbd "M-%") 'anzu-query-replace)
  (global-set-key (kbd "C-M-%") 'anzu-query-replace-regexp))


;; Customized functions
(defun prelude-move-beginning-of-line (arg)
  "Move point back to indentation of beginning of line.

Move point to the first non-whitespace character on this line.
If point is already there, move to the beginning of the line.
Effectively toggle between the first non-whitespace character and
the beginning of the line.

If ARG is not nil or 1, move forward ARG - 1 lines first. If
point reaches the beginning or end of the buffer, stop there."
  (interactive "^p")
  (setq arg (or arg 1))

  ;; Move lines first
  (when (/= arg 1)
    (let ((line-move-visual nil))
      (forward-line (1- arg))))

  (let ((orig-point (point)))
    (back-to-indentation)
    (when (= orig-point (point))
      (move-beginning-of-line 1))))

(global-set-key (kbd "C-a") 'prelude-move-beginning-of-line)

(defadvice kill-ring-save (before slick-copy activate compile)
  "When called interactively with no active region, copy a single
line instead."
  (interactive
   (if mark-active (list (region-beginning) (region-end))
     (message "Copied line")
     (list (line-beginning-position)
           (line-beginning-position 2)))))

(defadvice kill-region (before slick-cut activate compile)
  "When called interactively with no active region, kill a single
  line instead."
  (interactive
   (if mark-active (list (region-beginning) (region-end))
     (list (line-beginning-position)
           (line-beginning-position 2)))))

;; kill a line, including whitespace characters until next non-whiepsace character
;; of next line
(defadvice kill-line (before check-position activate)
  (if (member major-mode
              '(emacs-lisp-mode scheme-mode lisp-mode
                                c-mode c++-mode objc-mode
                                latex-mode plain-tex-mode))
      (if (and (eolp) (not (bolp)))
          (progn (forward-char 1)
                 (just-one-space 0)
                 (backward-char 1)))))

;; taken from prelude-editor.el
;; automatically indenting yanked text if in programming-modes
(defvar yank-indent-modes
  '(LaTeX-mode TeX-mode)
  "Modes in which to indent regions that are yanked (or yank-popped).
Only modes that don't derive from `prog-mode' should be listed here.")

(defvar yank-indent-blacklisted-modes
  '(python-mode slim-mode haml-mode)
  "Modes for which auto-indenting is suppressed.")

(defvar yank-advised-indent-threshold 1000
  "Threshold (# chars) over which indentation does not automatically occur.")

(defun yank-advised-indent-function (beg end)
  "Do indentation, as long as the region isn't too large."
  (if (<= (- end beg) yank-advised-indent-threshold)
      (indent-region beg end nil)))

(defadvice yank (after yank-indent activate)
  "If current mode is one of 'yank-indent-modes,
indent yanked text (with prefix arg don't indent)."
  (if (and (not (ad-get-arg 0))
           (not (member major-mode yank-indent-blacklisted-modes))
           (or (derived-mode-p 'prog-mode)
               (member major-mode yank-indent-modes)))
      (let ((transient-mark-mode nil))
        (yank-advised-indent-function (region-beginning) (region-end)))))

(defadvice yank-pop (after yank-pop-indent activate)
  "If current mode is one of `yank-indent-modes',
indent yanked text (with prefix arg don't indent)."
  (when (and (not (ad-get-arg 0))
             (not (member major-mode yank-indent-blacklisted-modes))
             (or (derived-mode-p 'prog-mode)
                 (member major-mode yank-indent-modes)))
    (let ((transient-mark-mode nil))
      (yank-advised-indent-function (region-beginning) (region-end)))))

;; prelude-core.el
(defun indent-buffer ()
  "Indent the currently visited buffer."
  (interactive)
  (indent-region (point-min) (point-max)))

;; prelude-editing.el
(defcustom prelude-indent-sensitive-modes
  '(coffee-mode python-mode slim-mode haml-mode yaml-mode)
  "Modes for which auto-indenting is suppressed."
  :type 'list)

(defun indent-region-or-buffer ()
  "Indent a region if selected, otherwise the whole buffer."
  (interactive)
  (unless (member major-mode prelude-indent-sensitive-modes)
    (save-excursion
      (if (region-active-p)
          (progn
            (indent-region (region-beginning) (region-end))
            (message "Indented selected region."))
        (progn
          (indent-buffer)
          (message "Indented buffer.")))
      (whitespace-cleanup))))

(global-set-key (kbd "C-c i") 'indent-region-or-buffer)

;; add duplicate line function from Prelude
;; taken from prelude-core.el
(defun prelude-get-positions-of-line-or-region ()
  "Return positions (beg . end) of the current line
or region."
  (let (beg end)
    (if (and mark-active (> (point) (mark)))
        (exchange-point-and-mark))
    (setq beg (line-beginning-position))
    (if mark-active
        (exchange-point-and-mark))
    (setq end (line-end-position))
    (cons beg end)))

;; smart openline
(defun prelude-smart-open-line (arg)
  "Insert an empty line after the current line.
Position the cursor at its beginning, according to the current mode.
With a prefix ARG open line above the current line."
  (interactive "P")
  (if arg
      (prelude-smart-open-line-above)
    (progn
      (move-end-of-line nil)
      (newline-and-indent))))

(defun prelude-smart-open-line-above ()
  "Insert an empty line above the current line.
Position the cursor at it's beginning, according to the current mode."
  (interactive)
  (move-beginning-of-line nil)
  (newline-and-indent)
  (forward-line -1)
  (indent-according-to-mode))

(global-set-key (kbd "M-o") 'prelude-smart-open-line)
(global-set-key (kbd "M-o") 'open-line)

(use-package projectile
  :bind-keymap ("C-x p" . projectile-command-map)
  :config
  (projectile-mode)
  (setq projectile-enable-caching t)
  (setq projectile-completion-system 'ivy))
;; (use-package helm
;;   :config
;;   (use-package helm-gtags
;;     :init

;;     (setq helm-gtags-ignore-case t
;;           helm-gtags-auto-update t
;;           helm-gtags-use-input-at-cursor t
;;           helm-gtags-pulse-at-cursor t
;;           helm-gtags-prefix-key "\C-cg"
;;           helm-gtags-suggested-key-mapping t)

;;     ;; Enable helm-gtags-mode in Dired so you can jump to any tag
;;     ;; when navigate project tree with Dired
;;     (add-hook 'dired-mode-hook 'helm-gtags-mode)

;;     ;; Enable helm-gtags-mode in Eshell for the same reason as above
;;     (add-hook 'eshell-mode-hook 'helm-gtags-mode)

;;     ;; Enable helm-gtags-mode in languages that GNU Global supports
;;     (add-hook 'c-mode-hook 'helm-gtags-mode)
;;     (add-hook 'c++-mode-hook 'helm-gtags-mode)
;;     (add-hook 'java-mode-hook 'helm-gtags-mode)
;;     (add-hook 'asm-mode-hook 'helm-gtags-mode)

;;     ;; key bindings

;;     (define-key helm-gtags-mode-map (kbd "C-c g a") 'helm-gtags-tags-in-this-function)
;;     (define-key helm-gtags-mode-map (kbd "C-j") 'helm-gtags-select)
;;     (define-key helm-gtags-mode-map (kbd "M-.") 'helm-gtags-dwim)
;;     (define-key helm-gtags-mode-map (kbd "M-,") 'helm-gtags-pop-stack)
;;     (define-key helm-gtags-mode-map (kbd "C-c <") 'helm-gtags-previous-history)
;;     (define-key helm-gtags-mode-map (kbd "C-c >") 'helm-gtags-next-history)
;;     )
;;   )

(use-package ggtags
  :hook
  (
   (c-mode-common . ggtags-mode)
   ;; (c++-mode . ggtags-mode))
   ))
(use-package prescient
  :config
  (prescient-persist-mode))
(use-package ivy
  :config
  (setq ivy-use-selectable-prompt t)
  (define-key ivy-minibuffer-map (kbd "C-n") 'ivy-next-line)
  (define-key ivy-minibuffer-map (kbd "C-p") 'ivy-previous-line)
  (global-set-key (kbd "M-s o") 'swiper)
  (global-set-key (kbd "M-s M-o") 'counsel-semantic-or-imenu)

  (ivy-mode 1))

(use-package ivy-rich
  :hook (ivy-mode . ivy-rich-mode)
  :custom (ivy-rich-path-style 'abbrev)
  :config
  (ivy-rich-modify-columns
   'ivy-switch-buffer
   '((ivy-rich-switch-buffer-size (:align right))
     (ivy-rich-switch-buffer-major-mode (:width 20 :face error)))))
(use-package all-the-icons-ivy-rich
  :config
  (all-the-icons-ivy-rich-mode))
(use-package lsp-ivy :commands lsp-ivy-workspace-symbol)
(use-package lsp-treemacs
  :config
  (lsp-treemacs-sync-mode 1))
(use-package lsp-mode
  :hook (
         (lsp-mode . lsp-enable-which-key-integration)
         (c-mode-common . lsp))
  :init
  (setq gc-cons-threshold (* 100 1024 1024)
        read-process-output-max (* 1024 1024)
        treemacs-space-between-root-nodes nil
        company-idle-delay 0.0
        company-minimum-prefix-length 1
        lsp-idle-delay 0.1 ;; clangd is fast
        ;; be more ide-ish
        lsp-headerline-breadcrumb-enable t)
  )
;; (add-hook 'c-mode-common-hook #' lsp))

(use-package powerthesaurus
  :bind
  (("C-x C-." . powerthesaurus-lookup-word-dwim)))


(use-package grammarly
  ;; :custom ((grammarly-username "hojoon.lee@skku.edu")
  ;;          (grammarly-password "Ttlxmpa-l33t"))
  :config
  ;; (add-to-list 'grammarly-on-message-function-list 'test-on-message)
  ;; (defun test-on-message (data)
  ;;   "On message callback with DATA."
  ;;   (message "[DATA] %s" data))
  )
;; (setcdr (nth 1 auth) grammarly--cookies)
;; Set callback for receiving data.
;; (grammarly-check-text "Hello World")
(use-package flycheck-grammarly)
;; :hook
;; ((LaTeX-mode . flyspell-grammarly)))
(use-package lsp-latex
  :straight (lsp-latex :type git :host github :repo "ROCKTAKEY/lsp-latex")
  :custom
  (lsp-latex-texlab-executable "~/.cargo/bin/texlab")
  (lsp-latex-forward-search-executable "emacsclient")
  (lsp-latex-forward-search-args
   '("--eval"
     "(lsp-latex-forward-search-with-pdf-tools \"%f\" \"%p\" \"%l\")"))
  (lsp-latex-forward-search-after "true")

  :hook
  ((tex-mode . lsp)
   (LaTeX-mode . lsp)
   (bibtex-mode . lsp))
  )
(use-package flyspell-correct-ivy)
(use-package counsel
  :config (counsel-mode 1))
(use-package posframe)
(use-package ivy-posframe
  :custom
  (ivy-posframe-display-functions-alist '((t . ivy-posframe-display)))
  :config
  (ivy-posframe-mode 1)
  (setq ivy-posframe-width 100
        posframe-mouse-banish t)
  )
(use-package ivy-prescient
  :config (ivy-prescient-mode))
(use-package counsel-projectile
  :config (counsel-projectile-mode 1))
;; (use-package counsel-gtags
;;   :bind-keymap ("C-c g" . counsel-gtags-command-map)
;;   :config
;;   (counsel-gtags-mode 1)
;;   (add-hook 'c-mode-hook 'counsel-gtags-mode)
;;   (add-hook 'c++-mode-hook 'counsel-gtags-mode)
;;   (define-key counsel-gtags-mode-map (kbd "M-t") 'counsel-gtags-find-definition)
;;   (define-key counsel-gtags-mode-map (kbd "M-r") 'counsel-gtags-find-reference)
;;   (define-key counsel-gtags-mode-map (kbd "M-s") 'counsel-gtags-find-symbol)
;;   (define-key counsel-gtags-mode-map (kbd "M-,") 'counsel-gtags-go-backward)
;;   (define-key counsel-gtags-mode-map (kbd "M-.") 'counsel-gtags-dwim))



(use-package ede
  :config (global-ede-mode))
(use-package semantic
  :hook
  (semantic-init . semantic-reset-system-include)
  :config
  (global-semanticdb-minor-mode 1)
  (global-semantic-idle-scheduler-mode 1)
  (semantic-mode 1)
  (setq semantic-new-buffer-setup-functions
        (cl-remove-if (lambda (buffer-setup-function)
                        (member (car buffer-setup-function)
                                '(python-mode html-mode)))
                      semantic-new-buffer-setup-functions))
  (semantic-remove-system-include "/usr/include/" 'c++-mode)
  (semantic-remove-system-include "/usr/local/include/" 'c++-mode)
  (setq-mode-local c-mode semanticdb-find-default-throttle
                   '(local project unloaded recursive))[]
  (setq-mode-local c++-mode semanticdb-find-default-throttle
                   '(local project unloaded recursive))
  (remove-hook 'python-mode-hook 'wisent-python-default-setup))



(use-package irony
  :init
  (defun my-irony-mode-hook ()
    "Custom irony mode hook to remap keys."
    (define-key irony-mode-map [remap completion-at-point]
      'irony-completion-at-point-async)
    (define-key irony-mode-map [remap complete-symbol]
      'irony-completion-at-point-async))

  :hook (
         (c++-mode . irony-mode)
         (c-mode .irony-mode)
         (objc-mode . irony-mode)
         (irony-mode . irony-cdb-autosetup-compile-options)
         (irony-mode . company-irony-setup-begin-commands)
         (irony-mode . my-irony-mode-hook)
         ;; (semantic-init . semantic-reset-system-include)
         ))

(use-package json-mode)
(use-package company
  :bind (:map company-active-map ("<tab>" . company-complete-selection))
  :custom
  (frame-set-background-mode t)
  (x-gtk-use-system-tooltips nil)
  (tooltip-frame-parameters 1)
  (company-backends (delete 'company-semantic company-backends))
  (company-idle-delay 0.2)
  (company-abbrev 'company-dabbrev)
  (company-preview-if-just-one-frontend t)
  :config
  (global-company-mode)
  (add-to-list
   'company-backends '(
                       ;; company-semantic
                       company-clang
                       company-files
                       company-keywords
                       company-capf
                       company-yasnippet
                       )))
;; (use-package company-lsp
;;   :config
;;   (add-to-list 'company-backends 'company-lsp))
(use-package company-prescient
  :init (company-prescient-mode))
;; (use-package rtags)
;; (use-package company-rtags
;;   :config
;;   (add-to-list 'company-backends 'company-rtags))
(use-package company-irony
  :config
  (add-to-list 'company-backends 'company-irony))

(use-package company-irony-c-headers
  :config
  (add-to-list 'company-backends 'company-irony-c-headers))

;; (use-package company-yasnippet
;;   :after company
;;   :config
;;   (defun company-backend-with-yas (backends)
;;     "Add :with company-yasnippet to company BACKENDS.
;; Taken from https://github.com/syl20bnr/spacemacs/pull/179."
;;     (if (and (listp backends) (memq 'company-yasnippet backends))
;;         backends
;;       (append (if (consp backends)
;;                   backends
;;                 (list backends))
;;               '(:with company-yasnippet))))
;;   ;; add yasnippet to all backends
;;   (setq company-backends
;;         (mapcar 'company-backend-with-yas company-backends)))

(use-package company-posframe
  :hook (company-mode . company-posframe-mode))

(use-package company-box
  :hook (company-mode . company-box-mode)
  :after (company ivy-posframe)
  :custom
  (company-box-icons-alist 'company-box-icons-images)
  (company-box-doc-delay 0.2)
  (company-box-show-single-candidate t)
  (company-tooltip-align-annotations t)
  )
(use-package company-quickhelp
  :defines company-quickhelp-delay
  :bind (:map company-active-map
              ("M-h" . company-quickhelp-manual-begin))

  :custom (company-quickhelp-delay 0.2)
  :config
  (company-quickhelp-mode)
  )

;; Folding code
(use-package hideshow
  :init
  (defun toggle-selective-display (column)
    (interactive "P")
    (set-selective-display
     (or column
         (unless selective-display
           (1+ (current-column))))))

  (defun toggle-hiding (column)
    (interactive "P")
    (if hs-minor-mode
        (if (condition-case nil
                (hs-toggle-hiding)
              (error t))
            (hs-show-all))
      (toggle-selective-display column)))
  (global-set-key (kbd "C-x \\") 'toggle-hiding)
  (global-set-key (kbd "C-\\") 'toggle-selective-display)
  (add-hook 'c-mode-common-hook  'hs-minor-mode)
  (add-hook 'emacs-lisp-mode-hook 'hs-minor-mode)

  )
;; (use-package aggressive-indent
;;   :defines (aggressive-indent-excluded-modes)
;;   :hook (prog-mode . aggressive-indent-mode)
;;   :init
;;   ;; (global-aggressive-indent-mode 1)
;;   (add-to-list 'aggressive-indent-excluded-modes '(html-mode dockerfile-mode lsp-mode))
;;   )
(use-package org-bullets)
(defun my-org-mode-hook ()
  "My org mode hook."
  (add-hook 'completion-at-point-functions 'pcomplete-completions-at-point nil t)
  (setq org-support-shift-select t)
  (setq org-src-tab-acts-natively t)
  (org-bullets-mode 1)
  )
(add-hook 'org-mode-hook #'my-org-mode-hook)

(use-package markdown-mode
  :commands (markdown-mode gfm-mode)
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))
  :custom (markdown-command "multimarkdown"))

(use-package tex
  :straight auctex
  :mode ("\\.tex\\'" . LaTeX-mode)
  :hook (
         (LaTeX-mode . visual-line-mode)
         (LaTeX-mode . flyspell-mode)
         (LaTeX-mode . LaTeX-math-mode)
         (LaTeX-mode . reftex-mode)
         (LaTeX-mode . TeX-PDF-mode)
         (LaTeX-mode . TeX-source-correlate-mode)

         ;; revert pdf-view after compilation
         (TeX-after-compilation-finished-functions . #'TeX-revert-document-buffer) ;
         )
  :custom
  (TeX-auto-save t)
  (TeX-parse-self t)
  (TeX-save-query nil)
  (TeX-view-program-selection '((output-pdf "PDF Tools"))
                              TeX-source-correlate-start-server t
                              TeX-source-correlate-method 'synctex
                              )
  (reftex-plug-into-AUCTeX t)
  (reftex-bibliography-commands '("bibliography" "nobibliography" "addbibresource"))
  :config
  ;; (dolist (hook '(latex-mode-hook LaTeX-mode-hook)))
  ;; (setq-default TeX-master nil)

  ;; (defun guess-TeX-master (filename)
  ;;   "Guess the master file for FILENAME from currently open .tex files."
  ;;   (let ((candidate nil)
  ;;         (filename (file-name-nondirectory filename)))
  ;;     (save-excursion
  ;;       (dolist (buffer (buffer-list))
  ;;         (with-current-buffer buffer
  ;;           (let ((name (buffer-name))
  ;;                 (file buffer-file-name))
  ;;             (if (and file (string-match "\\.tex$" file))
  ;;                 (progn
  ;;                   (goto-char (point-min))
  ;;                   (if (re-search-forward (concat "\\\\input{" filename "}") nil t)
  ;;                       (setq candidate file))
  ;;                   (if (re-search-forward (concat "\\\\include{" (file-name-sans-extension filename) "}") nil t)
  ;;                       (setq candidate file))))))))
  ;;     (if candidate
  ;;         (message "TeX master document: %s" (file-name-nondirectory candidate)))
  ;;     candidate))
  ;; (add-hook 'LaTeX-mode-hook
  ;;           '(lambda ()
  ;;              (setq TeX-master (guess-TeX-master (buffer-file-name)))))
  )

(use-package company-bibtex
  :config (add-to-list 'company-backends '(company-bibtex)))

(use-package company-reftex
  :config (add-to-list 'company-backends '(company-reftex-labels company-reftex-citations)))

(use-package company-auctex
  :config
  (company-auctex-init))

(use-package pdf-tools
  :custom
  (pdf-view-display-size 'fit-page)
  (pdf-annot-activate-created-annotations t)
  (pdf-view-resize-factor 1.1)
  :magic ("%PDF" . pdf-view-mode)
  :config (pdf-tools-install :no-query)
  )
;; terminal
(use-package vterm
  :config (define-key global-map (kbd "<f2>") 'vterm ))

;; (use-package ssublimity
;;   :config  (sublimity-mode 1))

;; (setq  helm-display-function 'helm-display-buffer-in-own-frame
;;        ;; helm-display-function 'my-helm-display-child-frame
;;        helm-display-buffer-reuse-frame t
;;        helm-display-buffer-width 100)

(defun reload-configs ()
  ;; Reload the config file
  (interactive)
  (load-file "~/.emacs")
  )
(defun open-config-file ()
  "Open this file."
  (interactive)
  (find-file "~/.emacs")
  (org-mode)

  )
;; define function to shutdown emacs server instance
(defun server-shutdown ()
  "Save buffers, Quit, and Shutdown (kill) server."
  (interactive)
  (save-some-buffers)
  (kill-emacs)
  )

;;    (use-package jupyter
;;    :init
;;  (use-package zmq))
(use-package ace-window
  :bind
  (("M-o". 'ace-window))
  )
(use-package avy
  :config
  (defhydra hydra-avy (:exit t :hint nil)
    "
 Line^^       Region^^        Goto
----------------------------------------------------------
 [_y_] yank   [_Y_] yank      [_c_] timed char  [_C_] char
 [_m_] move   [_M_] move      [_w_] word        [_W_] any word
 [_k_] kill   [_K_] kill      [_l_] line        [_L_] end of line"
    ("c" avy-goto-char-timer)
    ("C" avy-goto-char)
    ("w" avy-goto-word-1)
    ("W" avy-goto-word-0)
    ("l" avy-goto-line)
    ("L" avy-goto-end-of-line)
    ("m" avy-move-line)
    ("M" avy-move-region)
    ("k" avy-kill-whole-line)
    ("K" avy-kill-region)
    ("y" avy-copy-line)
    ("Y" avy-copy-region))
  (global-set-key (kbd "C-j") 'hydra-avy/body)
  ;; :bind
  ;; (("C-j". 'avy-goto-word-1))
  ;; (("M-g g". 'avy-goto-line))
  )

(use-package ein
  :custom (ein:use-auto-complete-superpack t)
  :bind (("C-<return>". 'ein:worksheet-execute-cell-km))
  )
(use-package docker-compose-mode)
(use-package dockerfile-mode)
;; Save sessions
;; (setq desktop-save-mode t)
;; ;;
;; Independent key bindings
(global-set-key (kbd "C-x k") 'kill-current-buffer)
(global-set-key (kbd "C-x C-k") 'kill-buffer-and-window)
(global-set-key (kbd "C-x C-r") 'eval-region)
(global-set-key (kbd "M-<up>") 'beginning-of-defun)
(global-set-key (kbd "M-p") 'beginning-of-defun)
(global-set-key (kbd "M-<down>") 'end-of-defun)
(global-set-key (kbd "M-n") 'end-of-defun)

;; Mouse scrolling in terminal
(global-set-key (kbd "<mouse-4>") 'scroll-down-line)
(global-set-key (kbd "<mouse-5>") 'scroll-up-line)
(define-key global-map (kbd "<f9>") 'reload-configs)
(define-key global-map (kbd "<f5>") 'redraw-display)

(global-set-key
 (kbd "C-x SPC")
 (defhydra hydra-rectangle (:body-pre (rectangle-mark-mode 1)
                                      :color pink
                                      :post (deactivate-mark))
   "
  ^_k_^     _d_elete    _s_tring
_h_   _l_   _o_k        _y_ank
  ^_j_^     _n_ew-copy  _r_eset
^^^^        _e_xchange  _u_ndo
^^^^        ^ ^         _p_aste
"
   ("h" backward-char nil)
   ("l" forward-char nil)
   ("k" previous-line nil)
   ("j" next-line nil)
   ("e" exchange-point-and-mark nil)
   ("n" copy-rectangle-as-kill nil)
   ("d" delete-rectangle nil)
   ("r" (if (region-active-p)
            (deactivate-mark)
          (rectangle-mark-mode 1)) nil)
   ("y" yank-rectangle nil)
   ("u" undo nil)
   ("s" string-rectangle nil)
   ("p" kill-rectangle nil)
   ("o" nil nil)))

(define-key dired-mode-map
  "."
  (defhydra hydra-dired (:hint nil :color pink)
    "
_+_ mkdir          _v_iew           _m_ark             _(_ details        _i_nsert-subdir    wdired
_C_opy             _O_ view other   _U_nmark all       _)_ omit-mode      _$_ hide-subdir    C-x C-q : edit
_D_elete           _o_pen other     _u_nmark           _l_ redisplay      _w_ kill-subdir    C-c C-c : commit
_R_ename           _M_ chmod        _t_oggle           _g_ revert buf     _e_ ediff          C-c ESC : abort
_Y_ rel symlink    _G_ chgrp        _E_xtension mark   _s_ort             _=_ pdiff
_S_ymlink          ^ ^              _F_ind marked      _._ toggle hydra   \\ flyspell
_r_sync            ^ ^              ^ ^                ^ ^                _?_ summary
_z_ compress-file  _A_ find regexp
_Z_ compress       _Q_ repl regexp

T - tag prefix
"
    ("\\" dired-do-ispell)
    ("(" dired-hide-details-mode)
    (")" dired-omit-mode)
    ("+" dired-create-directory)
    ("=" diredp-ediff)         ;; smart diff
    ("?" dired-summary)
    ("$" diredp-hide-subdir-nomove)
    ("A" dired-do-find-regexp)
    ("C" dired-do-copy)        ;; Copy all marked files
    ("D" dired-do-delete)
    ("E" dired-mark-extension)
    ("e" dired-ediff-files)
    ("F" dired-do-find-marked-files)
    ("G" dired-do-chgrp)
    ("g" revert-buffer)        ;; read all directories again (refresh)
    ("i" dired-maybe-insert-subdir)
    ("l" dired-do-redisplay)   ;; relist the marked or singel directory
    ("M" dired-do-chmod)
    ("m" dired-mark)
    ("O" dired-display-file)
    ("o" dired-find-file-other-window)
    ("Q" dired-do-find-regexp-and-replace)
    ("R" dired-do-rename)
    ("r" dired-do-rsynch)
    ("S" dired-do-symlink)
    ("s" dired-sort-toggle-or-edit)
    ("t" dired-toggle-marks)
    ("U" dired-unmark-all-marks)
    ("u" dired-unmark)
    ("v" dired-view-file)      ;; q to exit, s to search, = gets line #
    ("w" dired-kill-subdir)
    ("Y" dired-do-relsymlink)
    ("z" diredp-compress-this-file)
    ("Z" dired-do-compress)
    ("q" nil)
    ("." nil :color blue))
  )

;; (set-window-margins nil 0)
;; (global-display-line-numbers-mode)
(add-hook 'prog-mode-hook 'display-line-numbers-mode t)
(scroll-bar-mode -1)
(xterm-mouse-mode +1) ;; Mouse clicks

(global-auto-revert-mode t)
;;(add-hook 'emacs-startup-hook 'desktop-read)

;; (setq left-fringe-width 10)

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(ansi-color-faces-vector
   [default bold shadow italic underline bold bold-italic bold])
 '(ansi-color-names-vector
   (vector "#ffffff" "#f36c60" "#8bc34a" "#fff59d" "#4dd0e1" "#b39ddb" "#81d4fa" "#263238"))
 '(custom-safe-themes
   '("79278310dd6cacf2d2f491063c4ab8b129fee2a498e4c25912ddaa6c3c5b621e" default))
 '(default-input-method "rfc1345")
 '(fci-rule-color "#212121")
 '(hl-sexp-background-color "#121212")
 '(hl-todo-keyword-faces
   '(("TODO" . "#dc752f")
     ("NEXT" . "#dc752f")
     ("THEM" . "#2aa198")
     ("PROG" . "#268bd2")
     ("OKAY" . "#268bd2")
     ("DONT" . "#d70000")
     ("FAIL" . "#d70000")
     ("DONE" . "#86dc2f")
     ("NOTE" . "#875f00")
     ("KLUDGE" . "#875f00")
     ("HACK" . "#875f00")
     ("TEMP" . "#875f00")
     ("FIXME" . "#dc752f")
     ("XXX+" . "#dc752f")
     ("\\?\\?\\?+" . "#dc752f")))
 '(jdee-db-active-breakpoint-face-colors (cons "#1c1f24" "#51afef"))
 '(jdee-db-requested-breakpoint-face-colors (cons "#1c1f24" "#7bc275"))
 '(jdee-db-spec-breakpoint-face-colors (cons "#1c1f24" "#484854"))
 '(objed-cursor-color "#ff665c")
 '(pdf-view-continuous t)
 '(pdf-view-midnight-colors '("#b2b2b2" . "#262626"))
 '(rustic-ansi-faces
   ["#242730" "#ff665c" "#7bc275" "#FCCE7B" "#51afef" "#C57BDB" "#5cEfFF" "#bbc2cf"])
 '(safe-local-variable-values
   '((org-roam-db-location . "./org-roam.db")
     (org-roam-directory . ".")))
 '(tetris-x-colors
   [[229 192 123]
    [97 175 239]
    [209 154 102]
    [224 108 117]
    [152 195 121]
    [198 120 221]
    [86 182 194]])
 '(vc-annotate-background nil)
 '(vc-annotate-color-map
   '((20 . "#B71C1C")
     (40 . "#FF5722")
     (60 . "#FFA000")
     (80 . "#558b2f")
     (100 . "#00796b")
     (120 . "#2196f3")
     (140 . "#4527A0")
     (160 . "#B71C1C")
     (180 . "#FF5722")
     (200 . "#FFA000")
     (220 . "#558b2f")
     (240 . "#00796b")
     (260 . "#2196f3")
     (280 . "#4527A0")
     (300 . "#B71C1C")
     (320 . "#FF5722")
     (340 . "#FFA000")
     (360 . "#558b2f")))
 '(vc-annotate-very-old-color nil))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(default ((t (:background "#2a2e38"))))
 )
(provide 'emacs)
;;; emacs ends here
